<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Batch Job Examples | RCE Quick-Start Guide</title>
  <meta name="description" content="This is a guide for performing research on the RCE" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Batch Job Examples | RCE Quick-Start Guide" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a guide for performing research on the RCE" />
  <meta name="github-repo" content="IQSS/dss-rce" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Batch Job Examples | RCE Quick-Start Guide" />
  
  <meta name="twitter:description" content="This is a guide for performing research on the RCE" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="batch-jobs.html"/>
<link rel="next" href="installing-custom-software.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">RCE quick-start guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>What is the RCE?</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#authors"><i class="fa fa-check"></i>Authors</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="rce-setup.html"><a href="rce-setup.html"><i class="fa fa-check"></i><b>1</b> RCE Setup</a>
<ul>
<li class="chapter" data-level="1.1" data-path="rce-setup.html"><a href="rce-setup.html#access"><i class="fa fa-check"></i><b>1.1</b> Access</a></li>
<li class="chapter" data-level="1.2" data-path="rce-setup.html"><a href="rce-setup.html#compute-nodes"><i class="fa fa-check"></i><b>1.2</b> Compute nodes</a></li>
<li class="chapter" data-level="1.3" data-path="rce-setup.html"><a href="rce-setup.html#project-folders-shared-space"><i class="fa fa-check"></i><b>1.3</b> Project folders &amp; shared space</a></li>
<li class="chapter" data-level="1.4" data-path="rce-setup.html"><a href="rce-setup.html#moving-your-data-on-and-off"><i class="fa fa-check"></i><b>1.4</b> Moving your data on and off</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="interactive-jobs.html"><a href="interactive-jobs.html"><i class="fa fa-check"></i><b>2</b> Interactive Jobs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="interactive-jobs.html"><a href="interactive-jobs.html#launching-applications"><i class="fa fa-check"></i><b>2.1</b> Launching applications</a></li>
<li class="chapter" data-level="2.2" data-path="interactive-jobs.html"><a href="interactive-jobs.html#available-applications"><i class="fa fa-check"></i><b>2.2</b> Available applications</a></li>
<li class="chapter" data-level="2.3" data-path="interactive-jobs.html"><a href="interactive-jobs.html#using-multiple-cpus"><i class="fa fa-check"></i><b>2.3</b> Using multiple CPUs</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="interactive-jobs.html"><a href="interactive-jobs.html#r"><i class="fa fa-check"></i><b>2.3.1</b> R</a></li>
<li class="chapter" data-level="2.3.2" data-path="interactive-jobs.html"><a href="interactive-jobs.html#python"><i class="fa fa-check"></i><b>2.3.2</b> Python</a></li>
<li class="chapter" data-level="2.3.3" data-path="interactive-jobs.html"><a href="interactive-jobs.html#other-languages"><i class="fa fa-check"></i><b>2.3.3</b> Other languages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="batch-jobs.html"><a href="batch-jobs.html"><i class="fa fa-check"></i><b>3</b> Batch Jobs</a>
<ul>
<li class="chapter" data-level="3.1" data-path="batch-jobs.html"><a href="batch-jobs.html#preparing-a-batch-submission"><i class="fa fa-check"></i><b>3.1</b> Preparing a batch submission</a></li>
<li class="chapter" data-level="3.2" data-path="batch-jobs.html"><a href="batch-jobs.html#submit-file-overview"><i class="fa fa-check"></i><b>3.2</b> Submit file overview</a></li>
<li class="chapter" data-level="3.3" data-path="batch-jobs.html"><a href="batch-jobs.html#monitoring-and-managing"><i class="fa fa-check"></i><b>3.3</b> Monitoring and managing</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="batch-job-examples.html"><a href="batch-job-examples.html"><i class="fa fa-check"></i><b>4</b> Batch Job Examples</a>
<ul>
<li class="chapter" data-level="4.1" data-path="batch-job-examples.html"><a href="batch-job-examples.html#r-1"><i class="fa fa-check"></i><b>4.1</b> R</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="batch-job-examples.html"><a href="batch-job-examples.html#power-simulation"><i class="fa fa-check"></i><b>4.1.1</b> Power simulation</a></li>
<li class="chapter" data-level="4.1.2" data-path="batch-job-examples.html"><a href="batch-job-examples.html#varying-parameters"><i class="fa fa-check"></i><b>4.1.2</b> Varying parameters</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="batch-job-examples.html"><a href="batch-job-examples.html#python-1"><i class="fa fa-check"></i><b>4.2</b> Python</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="batch-job-examples.html"><a href="batch-job-examples.html#power-simulation-1"><i class="fa fa-check"></i><b>4.2.1</b> Power simulation</a></li>
<li class="chapter" data-level="4.2.2" data-path="batch-job-examples.html"><a href="batch-job-examples.html#varying-parameters-1"><i class="fa fa-check"></i><b>4.2.2</b> Varying parameters</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="batch-job-examples.html"><a href="batch-job-examples.html#stata"><i class="fa fa-check"></i><b>4.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="installing-custom-software.html"><a href="installing-custom-software.html"><i class="fa fa-check"></i><b>5</b> Installing Custom Software</a>
<ul>
<li class="chapter" data-level="5.1" data-path="installing-custom-software.html"><a href="installing-custom-software.html#conda-environments"><i class="fa fa-check"></i><b>5.1</b> Conda environments</a></li>
<li class="chapter" data-level="5.2" data-path="installing-custom-software.html"><a href="installing-custom-software.html#conda-setup"><i class="fa fa-check"></i><b>5.2</b> Conda setup</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">RCE Quick-Start Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="batch-job-examples" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Batch Job Examples</h1>
<p>RCE users come from a variety of backgrounds and different people are
more proficient with different software packages. Feel free to skip to
the batch examples using the software you are most comfortable with:</p>
<div id="r-1" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> R</h2>
<div id="power-simulation" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Power simulation</h3>
<p>The simplest kind of batch job is one for which you just want to run the
same code multiple times, without varying any parameters. For example,
suppose that we wish to run a power simulation for a t.test with unequal
group sizes.</p>
<ol style="list-style-type: decimal">
<li><p>Simulation script</p>
<p>The first step is to write a script or program to carry out the
desired computation. The R script below simulates distributions with
a specified mean difference, performs two-sample t-tests on the
difference, and calculates the proportion of significant tests.</p>
<div class="sourceCode" id="cb14" rundoc-language="R" rundoc-tangle="R_examples/power1/power.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb14-1"><a href="batch-job-examples.html#cb14-1"></a><span class="co">## function to simulate data and perform a t.test</span></span>
<span id="cb14-2"><a href="batch-job-examples.html#cb14-2"></a>sim.ttest &lt;-<span class="st"> </span><span class="cf">function</span>(mu1, mu2, sd, n1, n2) {</span>
<span id="cb14-3"><a href="batch-job-examples.html#cb14-3"></a>    d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;group1&quot;</span>, n1), <span class="kw">rep</span>(<span class="st">&quot;group2&quot;</span>, n2)),</span>
<span id="cb14-4"><a href="batch-job-examples.html#cb14-4"></a>                    <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(n1, <span class="dt">mean =</span> mu1, <span class="dt">sd =</span> sd),</span>
<span id="cb14-5"><a href="batch-job-examples.html#cb14-5"></a>                          <span class="kw">rnorm</span>(n2, <span class="dt">mean =</span> mu2, <span class="dt">sd =</span> sd)))</span>
<span id="cb14-6"><a href="batch-job-examples.html#cb14-6"></a>    <span class="kw">return</span>(<span class="kw">t.test</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d)<span class="op">$</span>p.value)</span>
<span id="cb14-7"><a href="batch-job-examples.html#cb14-7"></a>}</span>
<span id="cb14-8"><a href="batch-job-examples.html#cb14-8"></a></span>
<span id="cb14-9"><a href="batch-job-examples.html#cb14-9"></a><span class="co">##  run the function 10,000 times</span></span>
<span id="cb14-10"><a href="batch-job-examples.html#cb14-10"></a>p &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">10000</span>,</span>
<span id="cb14-11"><a href="batch-job-examples.html#cb14-11"></a>               <span class="kw">sim.ttest</span>(<span class="dt">mu1 =</span> <span class="dv">1</span>,</span>
<span id="cb14-12"><a href="batch-job-examples.html#cb14-12"></a>                         <span class="dt">mu2 =</span> <span class="fl">1.3</span>,</span>
<span id="cb14-13"><a href="batch-job-examples.html#cb14-13"></a>                         <span class="dt">sd =</span> <span class="dv">1</span>,</span>
<span id="cb14-14"><a href="batch-job-examples.html#cb14-14"></a>                         <span class="dt">n1 =</span> <span class="dv">50</span>,</span>
<span id="cb14-15"><a href="batch-job-examples.html#cb14-15"></a>                         <span class="dt">n2 =</span> <span class="dv">150</span>))</span>
<span id="cb14-16"><a href="batch-job-examples.html#cb14-16"></a><span class="co">## calculate the proportion of significant tests</span></span>
<span id="cb14-17"><a href="batch-job-examples.html#cb14-17"></a><span class="kw">cat</span>(<span class="kw">length</span>(p[p <span class="op">&lt;</span><span class="st"> </span><span class="fl">.05</span>])<span class="op">/</span><span class="kw">length</span>(p))</span></code></pre></div></li>
<li><p>Submit file</p>
<p>If we want to run this function one million times it may take a
while, especially if our computer is an older less powerful model.
So let’s run it on 100 separate machines (each one will simulate the
test 10000 times). To do that we need, in addition to the R script
above, a submit file to request resources and run the computation.</p>
<pre class="conf rundoc-block" rundoc-language="conf" rundoc-eval="no" rundoc-tangle="R_examples/power1/power.submit"><code># Universe whould always be &#39;vanilla&#39;. This line MUST be
#included in your submit file, exactly as shown below.
Universe = vanilla

# Enter the path to the R program.
Executable = /usr/local/bin/R

# Specify any arguments you want to pass to the executable.
# Here we pass arguments to make R not save or restore workspaces,
# and to run as quietly as possible.
Arguments = --no-save --no-restore --slave

# Specify the relative path to the input file
input = power.R

# Specify where to output any results printed by your program.
output = output/out.$(Process)
# Specify where to save any errors returned by your program.
error = output/error.$(Process)
# Specify where to save the log file.
Log = output/log

# Enter the number of processes to request.
# This section should always come last.
Queue 100</code></pre>
<p>Now that we have our script and the submit file we can run submit
the job as follows:</p>
<ol style="list-style-type: decimal">
<li>make a project folder for this run if it doesn’t exist</li>
<li>save the R script (as power.R) and the submit file (as
power.submit) in the project folder</li>
<li>make a sub folder named <code>output</code></li>
<li>open a terminal and <code>cd</code> to the project folder</li>
<li>run <code>condor_submit power.submit</code> to submit the jobs to the
cluster</li>
</ol></li>
<li><p>Aggregating results</p>
<p>When your batch job is finished you are usually left with multiple
output files that need to be aggregated. In the case of our
simulation example, we have files <code>output/out.0 -- output/out99</code>,
each of which contains a single number representing the proportion
of significant tests. We can aggregate them with a simple R script,
like this:</p>
<div class="sourceCode" id="cb16" rundoc-language="R" rundoc-eval="no" rundoc-tangle="R_examples/power1/aggregate.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb16-1"><a href="batch-job-examples.html#cb16-1"></a><span class="co">## list all output files in the output directory</span></span>
<span id="cb16-2"><a href="batch-job-examples.html#cb16-2"></a>output_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;output&quot;</span>,</span>
<span id="cb16-3"><a href="batch-job-examples.html#cb16-3"></a>                           <span class="dt">pattern =</span> <span class="st">&quot;^out</span><span class="ch">\\</span><span class="st">.[0-9]+$&quot;</span>,</span>
<span id="cb16-4"><a href="batch-job-examples.html#cb16-4"></a>                           <span class="dt">full.names=</span><span class="ot">TRUE</span>)</span>
<span id="cb16-5"><a href="batch-job-examples.html#cb16-5"></a></span>
<span id="cb16-6"><a href="batch-job-examples.html#cb16-6"></a><span class="co">## read each file, convert it to a number, and take the average</span></span>
<span id="cb16-7"><a href="batch-job-examples.html#cb16-7"></a><span class="kw">mean</span>(<span class="kw">as.double</span>(<span class="kw">sapply</span>(</span>
<span id="cb16-8"><a href="batch-job-examples.html#cb16-8"></a>                      output_files,</span>
<span id="cb16-9"><a href="batch-job-examples.html#cb16-9"></a>                      readLines,</span>
<span id="cb16-10"><a href="batch-job-examples.html#cb16-10"></a>                      <span class="dt">warn =</span> <span class="ot">FALSE</span>)))</span></code></pre></div></li>
<li><p>Try it yourself!</p>
<p>Download the <a href="examples_R/power1.zip">power simulation example
files</a>, to the RCE, extract the zip file and
running <code>condor_submit power.submit</code> in the <code>power1</code> directory.</p></li>
</ol>
</div>
<div id="varying-parameters" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Varying parameters</h3>
<p>The previous example was relatively simple, because we wanted to run
exactly the same code on all 100 nodes. Often however you want each node
to do something slightly different. For example, we may wish to vary the
sample size from 100 – 500 in increments of 10, to see how power
changes as a function of that parameter. In that case we need to pass
some additional information to each process, telling it which parameter
space it is responsible for.</p>
<p>As it turns out, we almost already know how to do that: if you you look
closely at the submit file in the previous example you will notice that
we used <code>$(Process)</code> to append the process number to the output and
error files.</p>
<ol style="list-style-type: decimal">
<li><p>Submit file passing process as an argument</p>
<p>We can use the <code>$(Process)</code> macro to pass information to our
program, like this:</p>
<pre class="conf rundoc-block" rundoc-language="conf" rundoc-eval="no" rundoc-tangle="R_examples/power2/power.submit"><code># Universe whould always be &#39;vanilla&#39;. This line MUST be
#included in your submit file, exactly as shown below.
Universe = vanilla

# Enter the path to the R program.
Executable = /usr/local/bin/R

# Specify any arguments you want to pass to the executable
# to make r not save or restore workspaces, and to
# run as quietly as possible
Arguments = --no-save --no-restore --slave --args $(Process)

# Specify the relative path to the input file
input = power.R

# Specify where to save any errors returned by your program.
error = output/error.$(Process)

Log = log.txt
# Enter the number of processes to request.
Queue 40</code></pre>
<p>Notice that we used <code>--args $(Process)</code> to pass the process number
to the R program. <code>$(Process)</code> will be an integer starting from <code>0</code>.</p></li>
<li><p>Argument processing</p>
<p>Next we need to 1) retrieve the process number in our R program
and 2) map it to the parameter space. We can retrieve the arguments
in R like this:</p>
<div class="sourceCode" id="cb18" rundoc-language="R" rundoc-eval="no" rundoc-tangle="R_examples/power2/power.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb18-1"><a href="batch-job-examples.html#cb18-1"></a><span class="co">## retrieve arguments passed from the command line.</span></span>
<span id="cb18-2"><a href="batch-job-examples.html#cb18-2"></a>process &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">as.character</span>(<span class="kw">commandArgs</span>(<span class="dt">trailingOnly =</span> <span class="ot">TRUE</span>)))</span></code></pre></div>
<p>We now have a variable in R that tells us which process we are. Now
we need to map that to our parameter space; recall that we want to
test sample sizes from 100 to 500, so we need to map <code>process 0</code> to
<code>n = 100</code>, <code>process 1</code> to <code>n = 110</code>, <code>process 2</code> to <code>n = 120</code> and so
on:</p>
<div class="sourceCode" id="cb19" rundoc-language="R" rundoc-eval="no" rundoc-tangle="R_examples/power2/power.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb19-1"><a href="batch-job-examples.html#cb19-1"></a><span class="co">## map process to sample size parameter.</span></span>
<span id="cb19-2"><a href="batch-job-examples.html#cb19-2"></a>n &lt;-<span class="st"> </span>(process <span class="op">+</span><span class="st"> </span><span class="dv">100</span>) <span class="op">+</span><span class="st"> </span>(process<span class="op">*</span><span class="dv">10</span> <span class="op">-</span><span class="st"> </span>process)</span></code></pre></div>
<p>There is one additional complication we need to handle: in the
previous example we did need to keep track of the parameters used by
each process because the parameters did not vary. Now that they do,
it would be nice if we had output that recorded the value of the
varying parameter as well as the result. We could of course just
print the <code>n</code> parameter we calculated from the process number along
with the result, but it will be easier to combine the outputs if we
write them to a machine-readable format (e.g., a
comma-separated-values file). You may have noticed that in the
submit file above I omitted the <code>output</code> directive: that is because
we are going to explicitly save the results in the R script, so we
don’t need the batch scheduler to save those output files for us.</p>
<p>Now we can set up the simulation as before, passing the <code>n</code>
calculated above into our simulation function, writing the results
to files.</p>
<div class="sourceCode" id="cb20" rundoc-language="R" rundoc-eval="no" rundoc-tangle="R_examples/power2/power.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb20-1"><a href="batch-job-examples.html#cb20-1"></a>  <span class="co">## function to simulate data and perform a t.test</span></span>
<span id="cb20-2"><a href="batch-job-examples.html#cb20-2"></a>  sim.ttest &lt;-<span class="st"> </span><span class="cf">function</span>(mu1, mu2, sd, n1, n2) {</span>
<span id="cb20-3"><a href="batch-job-examples.html#cb20-3"></a>      d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;group1&quot;</span>, n1), <span class="kw">rep</span>(<span class="st">&quot;group2&quot;</span>, n2)),</span>
<span id="cb20-4"><a href="batch-job-examples.html#cb20-4"></a>                      <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(n1, <span class="dt">mean =</span> mu1, <span class="dt">sd =</span> sd),</span>
<span id="cb20-5"><a href="batch-job-examples.html#cb20-5"></a>                            <span class="kw">rnorm</span>(n2, <span class="dt">mean =</span> mu2, <span class="dt">sd =</span> sd)))</span>
<span id="cb20-6"><a href="batch-job-examples.html#cb20-6"></a>      <span class="kw">return</span>(<span class="kw">t.test</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d)<span class="op">$</span>p.value)</span>
<span id="cb20-7"><a href="batch-job-examples.html#cb20-7"></a>  }</span>
<span id="cb20-8"><a href="batch-job-examples.html#cb20-8"></a></span>
<span id="cb20-9"><a href="batch-job-examples.html#cb20-9"></a>  <span class="co">##  run the function 10,000 times</span></span>
<span id="cb20-10"><a href="batch-job-examples.html#cb20-10"></a>  p &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">10000</span>,</span>
<span id="cb20-11"><a href="batch-job-examples.html#cb20-11"></a>                 <span class="kw">sim.ttest</span>(<span class="dt">mu1 =</span> <span class="dv">1</span>,</span>
<span id="cb20-12"><a href="batch-job-examples.html#cb20-12"></a>                           <span class="dt">mu2 =</span> <span class="fl">1.3</span>,</span>
<span id="cb20-13"><a href="batch-job-examples.html#cb20-13"></a>                           <span class="dt">sd =</span> <span class="dv">1</span>,</span>
<span id="cb20-14"><a href="batch-job-examples.html#cb20-14"></a>                           <span class="dt">n1 =</span> n,</span>
<span id="cb20-15"><a href="batch-job-examples.html#cb20-15"></a>                           <span class="dt">n2 =</span> n))</span>
<span id="cb20-16"><a href="batch-job-examples.html#cb20-16"></a><span class="kw">write.csv</span>(<span class="kw">data.frame</span>(<span class="dt">n =</span> n, <span class="dt">power =</span> <span class="kw">length</span>(p[p <span class="op">&lt;</span><span class="st"> </span><span class="fl">.05</span>])<span class="op">/</span><span class="kw">length</span>(p)),</span>
<span id="cb20-17"><a href="batch-job-examples.html#cb20-17"></a>          <span class="dt">row.names =</span> <span class="ot">FALSE</span>,</span>
<span id="cb20-18"><a href="batch-job-examples.html#cb20-18"></a>          <span class="dt">file =</span> <span class="kw">paste0</span>(<span class="st">&quot;output/out&quot;</span>, process, <span class="st">&quot;.csv&quot;</span>))</span></code></pre></div>
<p>Now we have all the required elements to submit out job, and can do
so using <code>condor_submit</code> as before.</p></li>
<li><p>Aggregating results</p>
<p>Each of our 40 processes produced a file in the <code>output</code> directory
name <code>out&lt;process&gt;csv</code>; our next task is to aggregate these results.
The R script below reads each of these files, joins them together
into a single data.frame, and plots the result.</p>
<div class="sourceCode" id="cb21" rundoc-language="R" rundoc-eval="no" rundoc-tangle="R_examples/power2/aggregate.R"><pre class="sourceCode r rundoc-block"><code class="sourceCode r"><span id="cb21-1"><a href="batch-job-examples.html#cb21-1"></a><span class="co">## list all output files in the output directory</span></span>
<span id="cb21-2"><a href="batch-job-examples.html#cb21-2"></a>output_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;output&quot;</span>,</span>
<span id="cb21-3"><a href="batch-job-examples.html#cb21-3"></a>                           <span class="dt">pattern =</span> <span class="st">&quot;^out[0-9]+</span><span class="ch">\\</span><span class="st">.csv$&quot;</span>,</span>
<span id="cb21-4"><a href="batch-job-examples.html#cb21-4"></a>                           <span class="dt">full.names=</span><span class="ot">TRUE</span>)</span>
<span id="cb21-5"><a href="batch-job-examples.html#cb21-5"></a></span>
<span id="cb21-6"><a href="batch-job-examples.html#cb21-6"></a><span class="co">## read each file and append them</span></span>
<span id="cb21-7"><a href="batch-job-examples.html#cb21-7"></a>results &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(output_files, read.csv))</span>
<span id="cb21-8"><a href="batch-job-examples.html#cb21-8"></a></span>
<span id="cb21-9"><a href="batch-job-examples.html#cb21-9"></a><span class="co">## plot</span></span>
<span id="cb21-10"><a href="batch-job-examples.html#cb21-10"></a><span class="kw">plot</span>(results)</span>
<span id="cb21-11"><a href="batch-job-examples.html#cb21-11"></a><span class="kw">abline</span>(<span class="dt">h =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="images/powerDist.png" /></p></li>
<li><p>Try it yourself!</p>
<p>Download the <a href="examples_R/power2.zip">power simulation example files</a>, to the RCE, extract the zip file, and
run the example by calling <code>condor_submit power.submit</code> from the
<code>power2</code> directory.</p></li>
</ol>
</div>
</div>
<div id="python-1" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Python</h2>
<div id="power-simulation-1" class="section level3" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Power simulation</h3>
<p>The simplest kind of batch job is one for which you just want to run the
same code multiple times, without varying any parameters. For example,
suppose that we wish to run a power simulation for a t-test with unequal
group sizes.</p>
<ol style="list-style-type: decimal">
<li><p>Simulation script</p>
<p>The first step is to write a script or program to carry out the
desired computation. The python script below simulates distributions
with a specified mean difference, performs two-sample t-tests on the
difference, and calculates the proportion of significant tests.</p>
<div class="sourceCode" id="cb22" rundoc-language="python" rundoc-tangle="Python_examples/power1/power.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb22-1"><a href="batch-job-examples.html#cb22-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-2"><a href="batch-job-examples.html#cb22-2"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb22-3"><a href="batch-job-examples.html#cb22-3"></a></span>
<span id="cb22-4"><a href="batch-job-examples.html#cb22-4"></a><span class="co">## function to simulate data and perform a t.test</span></span>
<span id="cb22-5"><a href="batch-job-examples.html#cb22-5"></a><span class="kw">def</span> sim_ttest(mu1, mu2, sd, n1, n2):</span>
<span id="cb22-6"><a href="batch-job-examples.html#cb22-6"></a>    x <span class="op">=</span> stats.norm.rvs(loc <span class="op">=</span> mu1, scale <span class="op">=</span> sd, size <span class="op">=</span> n1)</span>
<span id="cb22-7"><a href="batch-job-examples.html#cb22-7"></a>    y <span class="op">=</span> stats.norm.rvs(loc <span class="op">=</span> mu2, scale <span class="op">=</span> sd, size <span class="op">=</span> n2)</span>
<span id="cb22-8"><a href="batch-job-examples.html#cb22-8"></a>    <span class="cf">return</span>(stats.ttest_ind(x, y)[<span class="dv">1</span>])</span>
<span id="cb22-9"><a href="batch-job-examples.html#cb22-9"></a></span>
<span id="cb22-10"><a href="batch-job-examples.html#cb22-10"></a><span class="co">##  run the function 10,000 times</span></span>
<span id="cb22-11"><a href="batch-job-examples.html#cb22-11"></a>nsims <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb22-12"><a href="batch-job-examples.html#cb22-12"></a>p <span class="op">=</span> [sim_ttest(<span class="dv">1</span>, <span class="fl">1.3</span>, <span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">150</span>)  <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(nsims)]</span>
<span id="cb22-13"><a href="batch-job-examples.html#cb22-13"></a><span class="co">## calculate proportion of significant tests</span></span>
<span id="cb22-14"><a href="batch-job-examples.html#cb22-14"></a><span class="bu">print</span>(<span class="bu">len</span>([x <span class="cf">for</span> x <span class="kw">in</span> p <span class="cf">if</span> x <span class="op">&lt;</span> <span class="fl">.05</span>])<span class="op">/</span>nsims)</span></code></pre></div></li>
<li><p>Submit file</p>
<p>If we want to run this function one million times it may take a
while, especially if our computer is an older less powerful model.
So let’s run it on 100 separate machines (each one will simulate the
test 10000 times). To do that we need, in addition to the python
script above, a submit file to request resources and run the
computation.</p>
<pre class="conf rundoc-block" rundoc-language="conf" rundoc-eval="no" rundoc-tangle="Python_examples/power1/power.submit"><code># Universe whould always be &#39;vanilla&#39;. This line MUST be
#included in your submit file, exactly as shown below.
Universe = vanilla

# Enter the path to the python program.
Executable = /usr/local/bin/python33

# Specify any arguments you want to pass to the executable.
# Here we pass arguments to make python not save or restore workspaces,
# and to run as quietly as possible.
Arguments = power.py

# Note that unlike R batch job submission we pass the python script in
# the Arguments section rather than in the &quot;Input&quot; section.
# Specify the relative path to the input file

# Specify where to output any results printed by your program.
output = output/out.$(Process)
# Specify where to save any errors returned by your program.
error = output/error.$(Process)
# Specify where to save the log file.
Log = output/log

# Enter the number of processes to request.
# This section should always come last.
Queue 100</code></pre>
<p>Now that we have our script and the submit file we can run submit
the job as follows:</p>
<ol style="list-style-type: decimal">
<li>make a project folder for this run if it doesn’t exist</li>
<li>save the python script (as power.python) and the submit file (as
power.submit) in the project folder</li>
<li>make a sub folder named <code>output</code></li>
<li>open a terminal and <code>cd</code> to the project folder</li>
<li>run <code>condor_submit power.submit</code> to submit the jobs to the cluster</li>
</ol></li>
<li><p>Aggregating results</p>
<p>When your batch job is finished you are usually left with multiple
output files that need to be aggregated. In the case of our
simulation example, we have files <code>output/out.0 -- output/out99</code>,
each of which contains a single number representing the proportion
of significant tests. We can aggregate them with a simple python
script, like this:</p>
<div class="sourceCode" id="cb24" rundoc-language="python" rundoc-eval="no" rundoc-tangle="Python_examples/power1/aggregate.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb24-1"><a href="batch-job-examples.html#cb24-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-2"><a href="batch-job-examples.html#cb24-2"></a><span class="im">import</span> glob</span>
<span id="cb24-3"><a href="batch-job-examples.html#cb24-3"></a><span class="co">## list all output files in the output directory</span></span>
<span id="cb24-4"><a href="batch-job-examples.html#cb24-4"></a>output_files <span class="op">=</span> glob.glob(<span class="st">&quot;output/out*&quot;</span>)</span>
<span id="cb24-5"><a href="batch-job-examples.html#cb24-5"></a></span>
<span id="cb24-6"><a href="batch-job-examples.html#cb24-6"></a>output_values <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> f: np.<span class="bu">float</span>(<span class="bu">open</span>(f).read()), output_files)</span>
<span id="cb24-7"><a href="batch-job-examples.html#cb24-7"></a><span class="bu">print</span>(<span class="bu">list</span>(output_values))</span></code></pre></div></li>
<li><p>Try it yourself!</p>
<p>Download the <a href="examples_Python/power1.zip">power simulation example
files</a>, to the pythonCE, extract the zip
file and running <code>condor_submit power.submit</code> in the <code>power1</code>
directory.</p></li>
</ol>
</div>
<div id="varying-parameters-1" class="section level3" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Varying parameters</h3>
<p>The previous example was relatively simple, because we wanted to run
exactly the same code on all 100 nodes. Often however you want each node
to do something slightly different. For example, we may wish to vary the
sample size from 100 – 500 in increments of 10, to see how power
changes as a function of that parameter. In that case we need to pass
some additional information to each process, telling it which parameter
space it is responsible for.</p>
<p>As it turns out, we almost already know how to do that: if you you look
closely at the submit file in the previous example you will notice that
we used <code>$(Process)</code> to append the process number to the output and
error files.</p>
<ol style="list-style-type: decimal">
<li><p>Submit file passing process as an argument</p>
<p>We can use the <code>$(Process)</code> macro to pass information to our
program, like this:</p>
<pre class="conf rundoc-block" rundoc-language="conf" rundoc-eval="no" rundoc-tangle="Python_examples/power2/power.submit"><code>  # Universe whould always be &#39;vanilla&#39;. This line MUST be
  #included in your submit file, exactly as shown below.
  Universe = vanilla

  # Enter the path to the python program.
  Executable = /usr/local/bin/python33

  # Specify any arguments you want to pass to the executable
  Arguments = power.py $(Process)

# Specify where to output any results printed by your program.
  output = output/out.$(Process)

  # Specify where to save any errors returned by your program.
  error = output/error.$(Process)

  Log = log.txt
  # Enter the number of processes to request.
  Queue 40</code></pre>
<p>Notice that we used <code>--args $(Process)</code> to pass the process number
to the python program. <code>$(Process)</code> will be an integer starting from
<code>0</code>.</p></li>
<li><p>Argument processing</p>
<p>Next we need to 1) retrieve the process number in our python program
and 2) map it to the parameter space. We can retrieve the arguments
in python like this:</p>
<div class="sourceCode" id="cb26" rundoc-language="python" rundoc-eval="no" rundoc-tangle="Python_examples/power2/power.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb26-1"><a href="batch-job-examples.html#cb26-1"></a><span class="im">import</span> sys</span>
<span id="cb26-2"><a href="batch-job-examples.html#cb26-2"></a><span class="co">## retrieve arguments passed from the command line.</span></span>
<span id="cb26-3"><a href="batch-job-examples.html#cb26-3"></a>process <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span></code></pre></div>
<p>We now have a variable in python that tells us which process we are.
Now we need to map that to our parameter space; recall that we want
to test sample sizes from 100 to 500, so we need to map <code>process 0</code>
to <code>n = 100</code>, <code>process 1</code> to <code>n = 110</code>, <code>process 2</code> to <code>n = 120</code> and
so on:</p>
<div class="sourceCode" id="cb27" rundoc-language="python" rundoc-eval="no" rundoc-tangle="Python_examples/power2/power.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb27-1"><a href="batch-job-examples.html#cb27-1"></a><span class="co">## map process to sample size parameter.</span></span>
<span id="cb27-2"><a href="batch-job-examples.html#cb27-2"></a>n <span class="op">=</span> (process <span class="op">+</span> <span class="dv">100</span>) <span class="op">+</span> (process<span class="op">*</span><span class="dv">10</span> <span class="op">-</span> process)</span></code></pre></div>
<p>There is one additional complication we need to handle: in the
previous example we did need to keep track of the parameters used by
each process because the parameters did not vary. Now that they do,
it would be nice if we had output that recorded the value of the
varying parameter as well as the result. We could of course just
print the <code>n</code> parameter we calculated from the process number along
with the result, but it will be easier to combine the outputs if we
write them to a machine-readable format (e.g., a
comma-separated-values file). You may have noticed that in the
submit file above I omitted the <code>output</code> directive: that is because
we are going to explicitly save the results in the python script, so
we don’t need the batch scheduler to save those output files for us.</p>
<p>Now we can set up the simulation as before, passing the <code>n</code>
calculated above into our simulation function, writing the results
to files.</p>
<div class="sourceCode" id="cb28" rundoc-language="python" rundoc-eval="no" rundoc-tangle="Python_examples/power2/power.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb28-1"><a href="batch-job-examples.html#cb28-1"></a><span class="co">## function to simulate data and perform a t.test</span></span>
<span id="cb28-2"><a href="batch-job-examples.html#cb28-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-3"><a href="batch-job-examples.html#cb28-3"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb28-4"><a href="batch-job-examples.html#cb28-4"></a></span>
<span id="cb28-5"><a href="batch-job-examples.html#cb28-5"></a><span class="co">## function to simulate data and perform a t.test</span></span>
<span id="cb28-6"><a href="batch-job-examples.html#cb28-6"></a><span class="kw">def</span> sim_ttest(mu1, mu2, sd, n1, n2):</span>
<span id="cb28-7"><a href="batch-job-examples.html#cb28-7"></a>    x <span class="op">=</span> stats.norm.rvs(loc <span class="op">=</span> mu1, scale <span class="op">=</span> sd, size <span class="op">=</span> n1)</span>
<span id="cb28-8"><a href="batch-job-examples.html#cb28-8"></a>    y <span class="op">=</span> stats.norm.rvs(loc <span class="op">=</span> mu2, scale <span class="op">=</span> sd, size <span class="op">=</span> n2)</span>
<span id="cb28-9"><a href="batch-job-examples.html#cb28-9"></a>    <span class="cf">return</span>(stats.ttest_ind(x, y)[<span class="dv">1</span>])</span>
<span id="cb28-10"><a href="batch-job-examples.html#cb28-10"></a></span>
<span id="cb28-11"><a href="batch-job-examples.html#cb28-11"></a><span class="co">##  run the function 10,000 times</span></span>
<span id="cb28-12"><a href="batch-job-examples.html#cb28-12"></a>nsims <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb28-13"><a href="batch-job-examples.html#cb28-13"></a>p <span class="op">=</span> [sim_ttest(<span class="dv">1</span>, <span class="fl">1.3</span>, <span class="dv">1</span>, n, n)  <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(nsims)]</span>
<span id="cb28-14"><a href="batch-job-examples.html#cb28-14"></a><span class="bu">print</span>(<span class="bu">len</span>([x <span class="cf">for</span> x <span class="kw">in</span> p <span class="cf">if</span> x <span class="op">&lt;</span> <span class="fl">.05</span>])<span class="op">/</span>nsims)</span>
<span id="cb28-15"><a href="batch-job-examples.html#cb28-15"></a><span class="bu">print</span>(n)</span></code></pre></div>
<p>Now we have all the required elements to submit out job, and can do
so using <code>condor_submit</code> as before.</p></li>
<li><p>Aggregating results</p>
<p>Each of our 40 processes produced a file in the <code>output</code> directory
name <code>out&lt;process&gt;csv</code>; our next task is to aggregate these results.
The python script below reads each of these files, joins them
together into a single array, and plots the result.</p>
<div class="sourceCode" id="cb29" rundoc-language="python" rundoc-eval="no" rundoc-tangle="Python_examples/power2/aggregate.py"><pre class="sourceCode python rundoc-block"><code class="sourceCode python"><span id="cb29-1"><a href="batch-job-examples.html#cb29-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-2"><a href="batch-job-examples.html#cb29-2"></a><span class="im">import</span> glob</span>
<span id="cb29-3"><a href="batch-job-examples.html#cb29-3"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-4"><a href="batch-job-examples.html#cb29-4"></a><span class="co">## list all output files in the output directory</span></span>
<span id="cb29-5"><a href="batch-job-examples.html#cb29-5"></a>output_files <span class="op">=</span> glob.glob(<span class="st">&quot;output/out*&quot;</span>)</span>
<span id="cb29-6"><a href="batch-job-examples.html#cb29-6"></a></span>
<span id="cb29-7"><a href="batch-job-examples.html#cb29-7"></a>output_values <span class="op">=</span> np.array([x.split(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)[:<span class="dv">2</span>]</span>
<span id="cb29-8"><a href="batch-job-examples.html#cb29-8"></a>                          <span class="cf">for</span> x <span class="kw">in</span> [<span class="bu">open</span>(f).read() <span class="cf">for</span> f <span class="kw">in</span> output_files]],</span>
<span id="cb29-9"><a href="batch-job-examples.html#cb29-9"></a>                         dtype <span class="op">=</span> <span class="st">&quot;float&quot;</span>)</span>
<span id="cb29-10"><a href="batch-job-examples.html#cb29-10"></a></span>
<span id="cb29-11"><a href="batch-job-examples.html#cb29-11"></a>plt.plot(<span class="bu">list</span>(output_values[:, <span class="dv">1</span>]), <span class="bu">list</span>(output_values[:, <span class="dv">0</span>]), <span class="st">&quot;bo&quot;</span>)</span>
<span id="cb29-12"><a href="batch-job-examples.html#cb29-12"></a>plt.xlabel(<span class="st">&quot;Sample Size&quot;</span>)</span>
<span id="cb29-13"><a href="batch-job-examples.html#cb29-13"></a>plt.ylabel(<span class="st">&quot;Power&quot;</span>)</span>
<span id="cb29-14"><a href="batch-job-examples.html#cb29-14"></a>plt.savefig(<span class="st">&quot;power.png&quot;</span>)</span></code></pre></div>
<p><img src="images/python_powerDist.png" /></p></li>
<li><p>Try it yourself!</p>
<p>Download the <a href="examples_Python/power2.zip">power simulation example files</a>, to the pythonCE, extract the zip
file, and run the example by calling <code>condor_submit power.submit</code>
from the <code>power2</code> directory.</p></li>
</ol>
</div>
</div>
<div id="stata" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Stata</h2>
<pre><code>In this example we use the batch system to bootstrap a distribution of
means. Each process will calculate the mean for a single bootstrap
sample and save the result. Since we need to give the output files
unique names we will pass the batch process number to Stata and use it
to construct the file names.</code></pre>
<ol style="list-style-type: decimal">
<li><p>Bootstrap do-file</p>
<p>To use the batch system we need to write a do-file that does the
calculation without further user input. The do-file below reads a Stata
data set, sets a seed for random number generation, samples (with
replacement) from the data, calculates the average value of the sampled
data, and saves the result.</p>
<div class="sourceCode" id="cb31" rundoc-language="stata" rundoc-eval="no" rundoc-tangle="Stata_examples/bootstrap/bootstrap.do"><pre class="sourceCode stata rundoc-block"><code class="sourceCode stata"><span id="cb31-1"><a href="batch-job-examples.html#cb31-1"></a><span class="kw">set</span> <span class="kw">more</span> <span class="kw">off</span></span>
<span id="cb31-2"><a href="batch-job-examples.html#cb31-2"></a></span>
<span id="cb31-3"><a href="batch-job-examples.html#cb31-3"></a><span class="co">// collect the arguments passed by submit file</span></span>
<span id="cb31-4"><a href="batch-job-examples.html#cb31-4"></a><span class="kw">args</span> process</span>
<span id="cb31-5"><a href="batch-job-examples.html#cb31-5"></a></span>
<span id="cb31-6"><a href="batch-job-examples.html#cb31-6"></a><span class="co">// load the dataset</span></span>
<span id="cb31-7"><a href="batch-job-examples.html#cb31-7"></a><span class="kw">use</span> <span class="st">&quot;mydata&quot;</span>, <span class="kw">clear</span></span>
<span id="cb31-8"><a href="batch-job-examples.html#cb31-8"></a></span>
<span id="cb31-9"><a href="batch-job-examples.html#cb31-9"></a><span class="co">// set seed (shouldn&#39;t have to do this, but stata&#39;s</span></span>
<span id="cb31-10"><a href="batch-job-examples.html#cb31-10"></a><span class="co">// random bsample defaults to the same seed each time).</span></span>
<span id="cb31-11"><a href="batch-job-examples.html#cb31-11"></a><span class="co">// we nee to find a better way to do this.</span></span>
<span id="cb31-12"><a href="batch-job-examples.html#cb31-12"></a><span class="kw">set</span> <span class="dv">seed</span> <span class="ot">`process&#39;</span></span>
<span id="cb31-13"><a href="batch-job-examples.html#cb31-13"></a></span>
<span id="cb31-14"><a href="batch-job-examples.html#cb31-14"></a><span class="co">// sample with replacement</span></span>
<span id="cb31-15"><a href="batch-job-examples.html#cb31-15"></a><span class="kw">bsample</span>, <span class="kw">cluster</span>(id) idcluster(newid)</span>
<span id="cb31-16"><a href="batch-job-examples.html#cb31-16"></a></span>
<span id="cb31-17"><a href="batch-job-examples.html#cb31-17"></a><span class="co">// calculate the mean and standard deviation</span></span>
<span id="cb31-18"><a href="batch-job-examples.html#cb31-18"></a><span class="kw">collapse</span> (<span class="kw">mean</span>) mean_myvar = myvar (<span class="fu">sd</span>) sd_myvar = myvar</span>
<span id="cb31-19"><a href="batch-job-examples.html#cb31-19"></a></span>
<span id="cb31-20"><a href="batch-job-examples.html#cb31-20"></a><span class="co">// save the result, appending the process number to the file name</span></span>
<span id="cb31-21"><a href="batch-job-examples.html#cb31-21"></a><span class="kw">save</span> <span class="st">&quot;output/output_`process&#39;.dta&quot;</span>, <span class="kw">replace</span></span></code></pre></div>
<p>Note the use of <code>args process</code>, which retrieves the value of the process
argument. The argument itself is specified in the <code>.submit</code> file (see
below).</p></li>
<li><p>Submit file</p>
<p>The Stata code in the example above draws one bootstrap sample and
calculates the mean. If we want to do this 1,000 times we could write a
loop, but each iteration would be done sequentially. We can carry out
this operation faster by running it simultaneously on hundreds of
machines. We just need a <code>.submit</code> file like the one below:</p>
<pre class="conf rundoc-block" rundoc-language="conf" rundoc-eval="no" rundoc-tangle="Stata_examples/bootstrap/bootstrap.submit"><code># Universe whould always be &#39;vanilla&#39;. This line MUST be
#included in your submit file, exactly as shown below.
Universe = vanilla

# Enter the path to the Stata program.
Executable = /usr/local/bin/stata-mp

# Specify any arguments you want to pass to the executable.
# Here we pass arguments to make Stata run the bootstrap.do
# file. We also pass the process number, which will be used
# to append the process number to the output files.
Arguments = -q do bootstrap.do $(Process)

# Specify where to output any results printed by your program.
output = output/bootstrap$(Process).out
# Specify where to save any errors returned by your program.
error = output/bootstrap$(Process).err
# Specify where to save the log file.
Log = output/bootstrap$(Process).log

# Enter the number of processes to request.
# This section should always come last.
Queue 1000
</code></pre>
<p>Notice that we passed the <code>$(Process)</code> argument so that we can retrieve
that value in the do-file and save each output to a unique file that
includes the process name.</p>
<p>To submit this job we open a terminal on the RCE, <code>cd</code> to the project
folder and run <code>condor_submit bootstrap.submit</code> to submit the jobs to
the cluster.</p></li>
<li><p>Aggregating results</p>
<p>Each of our 1000 processes produced a file in the <code>output</code> directory
name <code>out&lt;process&gt;.dta</code>; our next task is to aggregate these results.
The do-file below reads each of these files, joins them together,
appends them, and plots the result.</p>
<div class="sourceCode" id="cb33" rundoc-language="Stata" rundoc-eval="no" rundoc-tangle="Stata_examples/bootstrap/aggregate.do"><pre class="sourceCode Stata rundoc-block"><code class="sourceCode stata"><span id="cb33-1"><a href="batch-job-examples.html#cb33-1"></a><span class="kw">clear</span></span>
<span id="cb33-2"><a href="batch-job-examples.html#cb33-2"></a><span class="kw">set</span> <span class="kw">more</span> <span class="kw">off</span></span>
<span id="cb33-3"><a href="batch-job-examples.html#cb33-3"></a><span class="co">// change to the output directory</span></span>
<span id="cb33-4"><a href="batch-job-examples.html#cb33-4"></a>cd output</span>
<span id="cb33-5"><a href="batch-job-examples.html#cb33-5"></a><span class="co">// get a list of the output files created by bootstrap.do</span></span>
<span id="cb33-6"><a href="batch-job-examples.html#cb33-6"></a><span class="kw">local</span> <span class="ot">list</span>: <span class="ot">dir</span> . files <span class="st">&quot;output*.dta&quot;</span></span>
<span id="cb33-7"><a href="batch-job-examples.html#cb33-7"></a><span class="co">//loop over the output files appending each one</span></span>
<span id="cb33-8"><a href="batch-job-examples.html#cb33-8"></a><span class="kw">local</span> f=1</span>
<span id="cb33-9"><a href="batch-job-examples.html#cb33-9"></a><span class="kw">foreach</span> file <span class="kw">of</span> <span class="kw">local</span> <span class="ot">list</span> {</span>
<span id="cb33-10"><a href="batch-job-examples.html#cb33-10"></a>        <span class="kw">di</span> <span class="st">&quot;`file&quot;</span>&#39;</span>
<span id="cb33-11"><a href="batch-job-examples.html#cb33-11"></a>        <span class="kw">if</span> <span class="ot">`f&#39;</span>== 1 {</span>
<span id="cb33-12"><a href="batch-job-examples.html#cb33-12"></a>                <span class="kw">use</span> <span class="ot">`file&#39;</span>, <span class="kw">clear</span></span>
<span id="cb33-13"><a href="batch-job-examples.html#cb33-13"></a>        }</span>
<span id="cb33-14"><a href="batch-job-examples.html#cb33-14"></a>        <span class="kw">else</span> {</span>
<span id="cb33-15"><a href="batch-job-examples.html#cb33-15"></a>                <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`file&#39;</span></span>
<span id="cb33-16"><a href="batch-job-examples.html#cb33-16"></a>        }</span>
<span id="cb33-17"><a href="batch-job-examples.html#cb33-17"></a>        <span class="kw">local</span> ++f</span>
<span id="cb33-18"><a href="batch-job-examples.html#cb33-18"></a>}</span>
<span id="cb33-19"><a href="batch-job-examples.html#cb33-19"></a><span class="co">// save the appended results</span></span>
<span id="cb33-20"><a href="batch-job-examples.html#cb33-20"></a><span class="kw">saveold</span> <span class="st">&quot;mybootresults&quot;</span>, <span class="kw">replace</span></span>
<span id="cb33-21"><a href="batch-job-examples.html#cb33-21"></a></span>
<span id="cb33-22"><a href="batch-job-examples.html#cb33-22"></a><span class="co">// make a histogram</span></span>
<span id="cb33-23"><a href="batch-job-examples.html#cb33-23"></a><span class="kw">hist</span>(mean_myvar)</span>
<span id="cb33-24"><a href="batch-job-examples.html#cb33-24"></a></span>
<span id="cb33-25"><a href="batch-job-examples.html#cb33-25"></a><span class="co">// save the graph</span></span>
<span id="cb33-26"><a href="batch-job-examples.html#cb33-26"></a><span class="kw">graph</span> <span class="kw">export</span> <span class="st">&quot;stata_bootstrap.eps&quot;</span>, <span class="kw">replace</span></span></code></pre></div>
<p><img src="images/stata_bootstrap.png" /></p></li>
<li><p>Try it yourself!</p>
<p>Download the <a href="examples_Stata/bootstrap.zip">bootstrap example files</a>, to
the RCE, extract the zip file, and run the example by calling
<code>condor_submit bootstrap.submit</code> from the <code>bootstrap</code> directory.</p></li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="batch-jobs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="installing-custom-software.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/IQSS/dss-rce/edit/master/batch_examples.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["RCE.pdf", "RCE.epub"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

</body>

</html>
